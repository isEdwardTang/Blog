---
layout: post
title: "Clean Code总结二之函数"
categories: Study
tags:   study Java
author: Edward
---

* content
{:toc}

这次总结有关函数使用去达到clean code的目的的技巧。

--------------------


## 一、函数

### 1、Small

- 一个函数最多不要超过100行，最佳是20行以内。
- if、else、while中的语句块应该是一行，比如一个函数。
- 函数的缩进层次不应该多余一层或两层

### 2、Do One Thing

一个函数只做一件事，这里的一件事不仅是指单纯的一件事，包括一个抽象等级上的几个步骤（函数实际上是把大一些的概念拆分为另一个抽象等级上的一系列步骤）。
- 判断一个函数是否仅仅做一件事的方法是看看函数可不可以进一步拆分。

### 3、One Level of Abstraction per Function

函数内的每一条语句都要出于同一个抽象级别上。

### 4、Switch语句

将switch语句埋藏到抽象工厂底下，即switch语句只用于使用多态创建不同的实体，而对于不同的函数，则用多态调用。下面是一个转化的例子：

v1.0

```java
public Money calculatePay(Employee e)
throws InvalidEmployeeType {
    switch (e.type) {
        case COMMISSIONED:
            return calculateCommissionedPay(e);
        case HOURLY:
            return calculateHourlyPay(e);
        case SALARIED:
            return calculateSalariedPay(e);
        default:
            throw new InvalidEmployeeType(e.type);
    }
}
```

v2.0

```java
public abstract class Employee {
    public abstract boolean isPayday();
    public abstract Money calculatePay();
    public abstract void deliverPay(Money pay);
}
-----------------
public interface EmployeeFactory {
    public Employee makeEmployee(EmployeeRecord r)
        throws InvalidEmployeeType;
}
-----------------
public class EmployeeFactoryImpl implements EmployeeFactory {
    public Employee makeEmployee(EmployeeRecord r)
        throws InvalidEmployeeType {
        switch (r.type) {
            case COMMISSIONED:
                return new CommissionedEmployee(r) ;
            case HOURLY:
                return new HourlyEmployee(r);
            case SALARIED:
                return new SalariedEmploye(r);
            default:
                throw new InvalidEmployeeType(r.type);
        }
    }
}
```

### 5、Use Descriptive Names

使用描述性的名字，函数名越长越能说明问题，命名方式要一致，使用和模块名一致的名字。

### 6、Function Arguments

- 函数的参数越少越好，参数越多越不容易弄清楚函数表达的意思
- 参数输入参数太多，测试时写测试案例也比较麻烦
- 尽量少使用输出参数，尽量用返回值代替
- 不要使用flag作为参数
- 二元函数最好转化为一元函数
- 函数参数太多，最好将参数封装成一个类
- 可变长参数最好使用二元
- 函数名字能表示函数的参数的顺序

### 7、Have No Side Effects

函数不要有副作用，不要有时序性的耦合。

### 8、Command Query Separation

函数要么是查询功能，要么是修改等的行为功能，不要同时做两件事

### 9、Prefer Exceptions to Returning Error Codes

我们经常会在if语句中把command当做表达式去使用，例如：`if (deletePage(page) == E_OK)`，
但是这样处理你需要立即处理错误，会导致更深层次的嵌套：

```java
if (deletePage(page) == E_OK) {
    if (registry.deleteReference(page.name) == E_OK) {
        if (configKeys.deleteKey(page.name.makeKey()) == E_OK){
            logger.log("page deleted");
        } else {
            logger.log("configKey not deleted");
        }
    } else {
        logger.log("deleteReference from registry failed");
    }
} else {
    logger.log("delete failed");
    return E_ERROR;
}
```

更好的方式是采用异常代替，

```java
try {
    deletePage(page);
    registry.deleteReference(page.name);
    configKeys.deleteKey(page.name.makeKey());
} catch (Exception e) {
    logger.log(e.getMessage());
}
```

但是另一方面，异常会使得代码结构混乱，我们可以把try/catch代码块从主体部分抽离出来，形成一个函数。
同时需要注意，这个函数只能做处理错误的事，不要做其他事。

### 10、Don’t Repeat Yourself

采用各种方式消除重复

### 11、Structured Programming

每个函数都只能有一个入口和一个出口，但是对于短小的函数，偶尔出现的return、break、contine语句没有坏处。

## 二、相关原则

- Stepdown Rule：每个函数后面都是下一个抽象级别的函数

- 五大原则(SOLID)：
    - SRP(Single Responsibility Principle)：对象应该具有单一功能的概念
    - OCP(Open Closed Principle)：软件体应该是对于扩展开放的，但是对于修改封闭的
    - LSP(Liskov Substitution Principle)：程序中的对象应该是可以在不改变程序正确性的前提下被它的子类所替换的
    - ISP(Interface Segregation Principle)：多个特定客户端接口要好于一个宽泛用途的接口
    - DIP(Dependency Inversion Principle)：一个方法应该遵从“依赖于抽象而不是一个实例”的概念。
